<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sutradhaar - AI Presentation Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
        }

        .input-section input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-section input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: white;
        }

        .status-loading {
            background: #17a2b8;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-success {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .script-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .script-preview h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .segment {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #4facfe;
        }

        .segment h4 {
            color: #4facfe;
            margin-bottom: 8px;
        }

        .segment p {
            color: #666;
            line-height: 1.5;
        }

        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
            margin: 5px; /* Added for spacing if multiple buttons */
        }

        .download-btn:hover {
            background: #218838;
        }

        .error-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            color: #721c24;
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Sutradhaar</h1>
            <p>AI-Powered Presentation Generator</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <label for="topic">Enter your presentation topic:</label>
                <input type="text" id="topic" placeholder="e.g., Introduction to Machine Learning, Climate Change, etc." />
            </div>
            
            <button class="generate-btn" id="generateBtn" onclick="generatePresentation()">
                <span id="btnText">Generate Presentation</span>
                <span id="btnSpinner" style="display: none;"><span class="loading-spinner"></span> Generating...</span>
            </button>
            
            <div class="status-section" id="statusSection">
                <h3>Progress Status</h3>
                <div class="status-item" id="scriptStatus">
                    <div class="status-icon status-pending">1</div>
                    <div>
                        <strong>Generating Script</strong>
                        <div class="status-text">Creating educational content structure...</div>
                    </div>
                </div>
                <div class="status-item" id="imagesStatus">
                    <div class="status-icon status-pending">2</div>
                    <div>
                        <strong>Generating Images</strong>
                        <div class="status-text">Creating visual content for slides...</div>
                    </div>
                </div>
                <div class="status-item" id="pdfStatus">
                    <div class="status-icon status-pending">3</div>
                    <div>
                        <strong>Creating PDF</strong>
                        <div class="status-text">Compiling final presentation...</div>
                    </div>
                </div>
                <div class="status-item" id="audioStatus">
                    <div class="status-icon status-pending">4</div>
                    <div>
                        <strong>Generating Audio</strong>
                        <div class="status-text">Creating narrations for slides...</div>
                    </div>
                </div>
                <div class="status-item" id="videoChunksStatus">
                    <div class="status-icon status-pending">5</div>
                    <div>
                        <strong>Generating Video Chunks</strong>
                        <div class="status-text">Preparing individual video segments...</div>
                    </div>
                </div>
                <div class="status-item" id="combineVideoStatus">
                    <div class="status-icon status-pending">6</div>
                    <div>
                        <strong>Combining Video</strong>
                        <div class="status-text">Assembling final video presentation...</div>
                    </div>
                </div>
            </div>
            
            <div class="script-preview" id="scriptPreview">
                <h3>üìÑ Generated Script Preview</h3>
                <div id="scriptContent"></div>
            </div>
            
            <div class="download-section" id="downloadSection">
                <h3>üéâ Presentation Ready!</h3>
                <p>Your presentation assets have been generated successfully.</p>
                <a href="#" class="download-btn" id="downloadPdfBtn" download>
                    üì• Download PDF
                </a>
                <a href="#" class="download-btn" id="downloadVideoBtn" download style="display: none;">
                    üé¨ Download Video
                </a>
            </div>
            
            <div class="error-section" id="errorSection">
                <h3>‚ùå Error</h3>
                <div id="errorMessage"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';  // Adjust if your FastAPI server runs on a different port
        let currentScriptId = null; // Store scriptId globally for sequential operations
        
        async function generatePresentation() {
            const topic = document.getElementById('topic').value.trim();
            
            if (!topic) {
                showError('Please enter a topic for your presentation.');
                return;
            }
            
            // Reset UI
            resetUI();
            setButtonLoading(true);
            document.getElementById('statusSection').style.display = 'block';
            
            try {
                // Step 1: Generate Script
                // Uses POST /generate-script
                updateStatus('scriptStatus', 'loading', 'Generating script content...');
                const scriptResponse = await fetch(`${API_BASE}/generate-script`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic: topic }),
                });
                
                if (!scriptResponse.ok) {
                    const errorData = await scriptResponse.json().catch(() => ({ detail: scriptResponse.statusText }));
                    throw new Error(`Script generation failed: ${errorData.detail || scriptResponse.statusText}`);
                }
                
                const scriptData = await scriptResponse.json();
                currentScriptId = scriptData.script_id; // Store scriptId
                
                updateStatus('scriptStatus', 'success', 'Script generated successfully!');
                showScriptPreview(scriptData.parsed_script, scriptData.topic);
                
                // Step 2: Generate Images
                // Uses POST /generate-images
                updateStatus('imagesStatus', 'loading', 'Generating images for slides...');
                const imagesResponse = await fetch(`${API_BASE}/generate-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        script_id: currentScriptId,
                        use_unsplash_fallback: true 
                    }),
                });
                
                if (!imagesResponse.ok) {
                    const errorData = await imagesResponse.json().catch(() => ({ detail: imagesResponse.statusText }));
                    throw new Error(`Image generation failed: ${errorData.detail || imagesResponse.statusText}`);
                }
                
                const imagesData = await imagesResponse.json();
                updateStatus('imagesStatus', 'success', 
                    `Images generated! (${imagesData.stats.vertex_ai_success} AI + ${imagesData.stats.unsplash_fallback} stock)`
                );
                
                // Step 3: Generate Audio
                // Uses POST /generate-audio
                updateStatus('audioStatus', 'loading', 'Generating audio narrations (this may take a moment)...');
                const audioResponse = await fetch(`${API_BASE}/generate-audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        script_id: currentScriptId,
                        speaker: "female" // Or make this configurable
                    }),
                });

                if (!audioResponse.ok) {
                    const errorData = await audioResponse.json().catch(() => ({ detail: audioResponse.statusText }));
                    throw new Error(`Audio generation failed: ${errorData.detail || audioResponse.statusText}`);
                }

                const audioData = await audioResponse.json();
                updateStatus('audioStatus', 'success', 
                    `Audio generated successfully! (${audioData.stats.successful} files)`
                );

                // Step 4: Generate PDF
                // Uses GET /presentation/{script_id}/pdf
                updateStatus('pdfStatus', 'loading', 'Creating PDF presentation...');
                const pdfResponse = await fetch(`${API_BASE}/presentation/${currentScriptId}/pdf`);
                
                if (!pdfResponse.ok) {
                    const errorData = await pdfResponse.json().catch(() => ({ detail: pdfResponse.statusText }));
                    throw new Error(`PDF generation failed: ${errorData.detail || pdfResponse.statusText}`);
                }
                
                const pdfBlob = await pdfResponse.blob();
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                updateStatus('pdfStatus', 'success', 'PDF presentation ready!');
                showDownloadSection(pdfUrl, `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_presentation.pdf`, null);

                // Step 5: Generate Video Chunks
                // Uses POST /generate-video-chunks-sequentially
                updateStatus('videoChunksStatus', 'loading', 'Generating video chunks (this may take a while)...');
                const videoChunksResponse = await fetch(`${API_BASE}/generate-video-chunks-sequentially`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_id: currentScriptId }),
                });

                if (!videoChunksResponse.ok) {
                    const errorData = await videoChunksResponse.json().catch(() => ({ detail: videoChunksResponse.statusText }));
                    throw new Error(`Video chunk generation failed: ${errorData.detail || videoChunksResponse.statusText}`);
                }
                const videoChunksData = await videoChunksResponse.json();
                if (videoChunksData.chunks_failed_generation > 0 || videoChunksData.chunks_skipped_preprocessing > 0) {
                     console.warn('Video chunk generation issues:', videoChunksData.generation_errors);
                     updateStatus('videoChunksStatus', 'success', `Video chunks processed with some issues. ${videoChunksData.chunks_successfully_generated} successful.`);
                } else {
                    updateStatus('videoChunksStatus', 'success', `Video chunks generated successfully (${videoChunksData.chunks_successfully_generated} chunks).`);
                }
                if (videoChunksData.chunks_successfully_generated === 0) {
                    throw new Error('No video chunks were successfully generated. Cannot proceed to combine video.');
                }

                // Step 6: Combine Video Chunks
                // Uses POST /combine-video-chunks
                updateStatus('combineVideoStatus', 'loading', 'Combining video chunks into final presentation (this may also take a while)...');
                const combineVideoResponse = await fetch(`${API_BASE}/combine-video-chunks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_id: currentScriptId,
                        transition_type: "fade", // Default transition
                        transition_duration: 1.0 // Default duration
                    }),
                });

                if (!combineVideoResponse.ok) {
                    const errorData = await combineVideoResponse.json().catch(() => ({ detail: combineVideoResponse.statusText }));
                    throw new Error(`Combining video failed: ${errorData.detail || combineVideoResponse.statusText}`);
                }
                const combineVideoData = await combineVideoResponse.json();
                const finalVideoPath = combineVideoData.final_video_path;
                // The final_video_path is a server path. We need to construct a downloadable URL.
                // Assuming your FastAPI serves 'generated_final_videos' similar to other static dirs.
                // e.g., app.mount("/final-videos", StaticFiles(directory="generated_final_videos"), name="final-videos")
                // The URL would then be `${API_BASE}/final-videos/${currentScriptId}/${output_filename}`
                // For simplicity, let's assume the backend returns a direct relative path that can be appended to API_BASE
                // Or, even better, if the backend could return a full URL or a path that's easy to make absolute.
                // For now, we'll construct it based on the typical structure.
                const videoFileName = finalVideoPath.split('/').pop();
                const videoUrl = `${API_BASE}/final_videos/${currentScriptId}/${videoFileName}`; // Adjust this if your static mount is different

                updateStatus('combineVideoStatus', 'success', 'Final video assembled!');
                showDownloadSection(pdfUrl, `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_presentation.pdf`, videoUrl, videoFileName);
                
            } catch (error) {
                console.error('Error in generation pipeline:', error);
                showError(`Process failed: ${error.message}`);
                // Mark the step that failed, if possible
                if (error.message.includes("Script generation")) updateStatus('scriptStatus', 'error', error.message);
                else if (error.message.includes("Image generation")) updateStatus('imagesStatus', 'error', error.message);
                else if (error.message.includes("Audio generation")) updateStatus('audioStatus', 'error', error.message);
                else if (error.message.includes("PDF generation")) updateStatus('pdfStatus', 'error', error.message);
                else if (error.message.includes("Video chunk generation")) updateStatus('videoChunksStatus', 'error', error.message);
                else if (error.message.includes("Combining video")) updateStatus('combineVideoStatus', 'error', error.message);

            } finally {
                setButtonLoading(false);
            }
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('.status-icon');
            const text = element.querySelector('.status-text');
            
            // Reset classes
            icon.className = 'status-icon';
            
            // Add new status class
            switch(status) {
                case 'loading':
                    icon.classList.add('status-loading');
                    icon.innerHTML = '‚è≥';
                    break;
                case 'success':
                    icon.classList.add('status-success');
                    icon.innerHTML = '‚úì';
                    break;
                case 'error':
                    icon.classList.add('status-error');
                    icon.innerHTML = '‚úó';
                    break;
                default:
                    icon.classList.add('status-pending');
                    icon.innerHTML = icon.innerHTML; // Keep original number
            }
            
            text.textContent = message;
        }
        
        function showScriptPreview(parsedScript, topic) {
            const previewSection = document.getElementById('scriptPreview');
            const content = document.getElementById('scriptContent');
            
            let html = `<div class="segment"><h4>üìã Topic: ${topic}</h4></div>`;
            
            parsedScript.forEach((segment, index) => {
                html += `
                    <div class="segment">
                        <h4>üìö Segment ${index + 1}: ${segment.segment_title}</h4>
                        <p><strong>Summary:</strong> ${segment.summary}</p>
                        <p><strong>Slides:</strong> ${segment.slides.length} slides with narration and visuals</p>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            previewSection.style.display = 'block';
        }
        
        function showDownloadSection(pdfUrl, pdfFilename, videoUrl, videoFilename) {
            const downloadSection = document.getElementById('downloadSection');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const downloadVideoBtn = document.getElementById('downloadVideoBtn');
            
            if (pdfUrl && pdfFilename) {
                downloadPdfBtn.href = pdfUrl;
                downloadPdfBtn.download = pdfFilename;
                downloadPdfBtn.style.display = 'inline-block';
            } else {
                downloadPdfBtn.style.display = 'none';
            }

            if (videoUrl && videoFilename) {
                downloadVideoBtn.href = videoUrl;
                downloadVideoBtn.download = videoFilename; // The browser will use this as the suggested name
                downloadVideoBtn.style.display = 'inline-block';
            } else {
                downloadVideoBtn.style.display = 'none';
            }
            downloadSection.style.display = 'block';
        }
        
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }
        
        function setButtonLoading(loading) {
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            btn.disabled = loading;
            btnText.style.display = loading ? 'none' : 'inline';
            btnSpinner.style.display = loading ? 'inline' : 'none';
        }
        
        function resetUI() {
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('scriptPreview').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            currentScriptId = null;
            
            // Reset status items
            ['scriptStatus', 'imagesStatus', 'audioStatus', 'pdfStatus', 'videoChunksStatus', 'combineVideoStatus'].forEach((id, index) => {
                const element = document.getElementById(id);
                const icon = element.querySelector('.status-icon');
                const text = element.querySelector('.status-text');
                
                icon.className = 'status-icon status-pending';
                icon.innerHTML = index + 1; // Update numbering
                
                const messages = [
                    'Creating educational content structure...',
                    'Creating visual content for slides...',
                    'Creating narrations for slides...',
                    'Compiling final presentation...',
                    'Preparing individual video segments...',
                    'Assembling final video presentation...'
                ];
                text.textContent = messages[index];
            });
        }
        
        // Allow Enter key to trigger generation
        document.getElementById('topic').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generatePresentation();
            }
        });
    </script>
</body>
</html>