<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>सूत्रधार - AI Presentation Generator</title>
    <!-- <link rel="icon" type="image/x-icon" href="favicon.png"> -->
    <link rel="icon" type="image/png" href="static/favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes softGlow {
            0%, 100% { opacity: 0.05; transform: scale(1); }
            50% { opacity: 0.15; transform: scale(1.03); }
        }
        
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .animate-scale-in { animation: scaleIn 0.8s ease-out forwards; }
        .animate-soft-glow { animation: softGlow 8s infinite ease-in-out; }
        
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            overflow: hidden;
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .progress-bar {
            height: 0.75rem; /* h-3 */
            background-color: #3b82f6; /* Tailwind blue-500 */
            width: 0%;
            transition: width 0.3s ease-out;
        }
        
        .blur-background {
            backdrop-filter: blur(8px);
        }
        
        .status-pending { color: #6b7280; } /* Gray for pending/default text */
        .status-loading { color: #f59e0b; } /* Amber for loading text */
        .status-success { color: #10b981; } /* Green for success text */
        .status-error { color: #ef4444; }   /* Red for error text */
        
        /* Icon background colors */
        .status-pending .status-icon, .status-icon.status-pending { background-color: #9ca3af; } /* Lighter gray for pending icon bg */
        .status-loading .status-icon, .status-icon.status-loading { background-color: #f59e0b; } /* Amber for loading icon bg */
        .status-success .status-icon, .status-icon.status-success { background-color: #10b981; } /* Green for success icon bg */
        .status-error .status-icon, .status-icon.status-error   { background-color: #ef4444; }   /* Red for error icon bg */


        .segment {
            background: #f8fafc;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Splash Screen -->
    <div id="splashScreen" class="min-h-screen flex flex-col items-center justify-center px-6 opacity-100 translate-y-0 transition-all duration-700 overflow-hidden">
        <!-- Moving Dots Background -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <!-- Large Soft Glowing Orbs -->
            <div class="absolute w-96 h-96 bg-blue-400 rounded-full animate-soft-glow" style="left: -10%; top: -15%; animation-delay: 0s; animation-duration: 10s;"></div>
            <div class="absolute w-80 h-80 bg-purple-400 rounded-full animate-soft-glow" style="right: -15%; top: 20%; animation-delay: -3s; animation-duration: 12s;"></div>
            <div class="absolute w-72 h-72 bg-indigo-400 rounded-full animate-soft-glow" style="left: 20%; bottom: -20%; animation-delay: -6s; animation-duration: 9s;"></div>

            <!-- Existing Small Dots -->
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 10%; top: 20%; animation-delay: 0.5s; animation-duration: 3s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 80%; top: 30%; animation-delay: 1s; animation-duration: 2.5s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 60%; top: 70%; animation-delay: 1.5s; animation-duration: 4s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 30%; top: 80%; animation-delay: 2s; animation-duration: 3.5s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 90%; top: 60%; animation-delay: 0.8s; animation-duration: 2.8s;"></div>
            
            <div class="absolute w-1 h-1 bg-purple-300/30 rounded-full animate-pulse" style="left: 5%; top: 50%; animation-delay: 0.2s; animation-duration: 4s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-indigo-300/30 rounded-full animate-pulse" style="left: 95%; top: 10%; animation-delay: 1.2s; animation-duration: 3.2s;"></div>
            <div class="absolute w-1 h-1 bg-blue-300/30 rounded-full animate-pulse" style="left: 40%; top: 5%; animation-delay: 1.8s; animation-duration: 2.5s;"></div>
            
            <div class="absolute w-2.5 h-2.5 bg-purple-300/30 rounded-full animate-pulse" style="left: 20%; top: 60%; animation-delay: 0.3s; animation-duration: 3.8s;"></div>
            <div class="absolute w-1 h-1 bg-indigo-300/30 rounded-full animate-pulse" style="left: 70%; top: 15%; animation-delay: 1.7s; animation-duration: 2.2s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/30 rounded-full animate-pulse" style="left: 50%; top: 90%; animation-delay: 2.2s; animation-duration: 3.3s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-purple-300/30 rounded-full animate-pulse" style="left: 5%; top: 5%; animation-delay: 0.1s; animation-duration: 4.5s;"></div>
            <div class="absolute w-1 h-1 bg-indigo-300/20 rounded-full animate-pulse" style="left: 85%; top: 85%; animation-delay: 2.5s; animation-duration: 3.7s;"></div>
            <div class="absolute w-2 h-2 bg-blue-300/20 rounded-full animate-pulse" style="left: 15%; top: 40%; animation-delay: 0.9s; animation-duration: 2.9s;"></div>
        </div>

        <!-- Logo with animated rings - Increased Size -->
        <div class="relative mb-8 animate-scale-in" style="animation-delay: 0.2s;">
            <div class="absolute inset-0 animate-ping opacity-70">
                <div class="w-32 h-32 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full opacity-20"></div>
            </div>
            <div class="absolute inset-2 animate-pulse opacity-80">
                <div class="w-28 h-28 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full opacity-40"></div>
            </div>
            <div class="relative w-24 h-24 bg-gradient-to-br from-blue-600 to-purple-700 rounded-full flex items-center justify-center shadow-2xl">
                <div class="text-white text-4xl font-bold">स</div>
            </div>
        </div>

        <!-- Main content -->
        <div class="text-center space-y-6 max-w-2xl">
            <h1 class="text-6xl md:text-7xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 bg-clip-text text-transparent animate-fade-in z-10" style="animation-delay: 0.5s; line-height: 1.5;">
                सूत्रधार
            </h1>
            
            <p class="text-xl md:text-2xl text-gray-700 leading-relaxed animate-fade-in" style="animation-delay: 0.8s;">
                AI-Powered Video Presentation Generator
            </p>
            
            <!-- Replace existing subtitle -->
            <p class="text-xl md:text-2xl text-gray-700 leading-relaxed animate-fade-in" style="animation-delay: 0.8s;">
                <b>Transform Ideas → Script → Slides → Video</b><br>
                <!-- <span class="text-lg">Powered by GPT-4o-mini & Google Imagen</span> -->
            </p>
            <!-- Before the Get Started button -->
            <div class="pt-8 animate-fade-in" style="animation-delay: 1.4s;">
                <button 
                    onclick="showMainPage()" 
                    class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold px-10 py-4 text-xl transition-all duration-300 transform hover:scale-110 hover:shadow-2xl shadow-xl rounded-lg focus:outline-none focus:ring-4 focus:ring-purple-300"
                >
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- Main Page -->
    <div id="mainPage" class="min-h-screen hidden opacity-0 translate-y-10 transition-all duration-700">
        <!-- Header -->
        <div class="relative z-10 p-6">
            <button onclick="showSplashScreen()" class="text-gray-700 hover:text-blue-600 transition-colors flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Home
            </button>
        </div>

        <!-- Moving Dots Background -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute w-1.5 h-1.5 bg-blue-300/20 rounded-full animate-pulse" style="left: 15%; top: 25%; animation-delay: 0.3s; animation-duration: 2.5s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-blue-300/20 rounded-full animate-pulse" style="left: 75%; top: 35%; animation-delay: 0.8s; animation-duration: 3s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-blue-300/20 rounded-full animate-pulse" style="left: 50%; top: 75%; animation-delay: 1.2s; animation-duration: 2.8s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-blue-300/20 rounded-full animate-pulse" style="left: 25%; top: 85%; animation-delay: 1.7s; animation-duration: 3.2s;"></div>
            <div class="absolute w-1.5 h-1.5 bg-blue-300/20 rounded-full animate-pulse" style="left: 85%; top: 55%; animation-delay: 0.6s; animation-duration: 2.7s;"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="flex flex-col items-center justify-center min-h-[80vh] px-6">
            <div class="max-w-4xl w-full">
                <!-- Header Section -->
                <div class="text-center space-y-6 mb-12">
                    <!-- Logo -->
                    <div class="flex justify-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-xl">
                            <div class="text-white text-2xl font-bold">स</div>
                        </div>
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent" style="line-height: 1.5;">
                        सूत्रधार
                    </h1>
                    
                    <p class="text-xl md:text-2xl text-gray-600 leading-relaxed">
                        AI-Powered Video Presentation Generator
                    </p>

                    <!-- Rotating Greeting -->
                    <div class="h-8 flex items-center justify-center">
                        <p id="greetingText" class="text-lg text-gray-500 transition-all duration-500 animate-fade-in">
                            Transform Text to Video
                        </p>
                    </div>
                </div>

                <!-- Video Player -->
                <video id="videoPlayer" controls class="w-full max-w-3xl mx-auto my-8 rounded-lg shadow-xl aspect-video bg-black border border-gray-200" style="display: none;">
                    <source id="videoSource" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>

                <!-- Input Section -->
                <div class="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl p-8 shadow-xl mb-8">
                    <div class="space-y-6">
                        <div>
                            <label for="topic" class="block text-lg font-semibold text-gray-700 mb-3">
                                Enter your presentation topic:
                            </label>
                            <input
                                type="text"
                                id="topic"
                                placeholder="e.g., Introduction to Machine Learning, Climate Change, etc."
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-lg focus:border-blue-500 focus:outline-none transition-colors"
                            />
                        </div>

                        <!-- Suggestion Tags -->
                        <div>
                            <p class="text-sm text-gray-600 mb-3">Quick suggestions:</p>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setSuggestion('Introduction to Machine Learning')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    Introduction to Machine Learning
                                </button>
                                <button onclick="setSuggestion('Climate Change and Global Warming')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    Climate Change and Global Warming
                                </button>
                                <button onclick="setSuggestion('History of Ancient Civilizations')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    History of Ancient Civilizations
                                </button>
                                <button onclick="setSuggestion('Quantum Physics Basics')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    Quantum Physics Basics
                                </button>
                                <button onclick="setSuggestion('Digital Marketing Strategies')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    Digital Marketing Strategies
                                </button>
                                <button onclick="setSuggestion('Sustainable Energy Solutions')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                    Sustainable Energy Solutions
                                </button>
                            </div>
                        </div>

                        <!-- Speaker Selection -->
                        <div class="pt-4">
                            <label class="block text-lg font-semibold text-gray-700 mb-3">Select Speaker Voice:</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="speakerFemale" name="speaker" value="female" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                                    <label for="speakerFemale" class="ml-2 block text-sm font-medium text-gray-700">Female</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="speakerMale" name="speaker" value="male" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="speakerMale" class="ml-2 block text-sm font-medium text-gray-700">Male</label>
                                </div>
                            </div>
                        </div>
                        
                        <button
                            onclick="generatePresentation()"
                            id="generateBtn"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-4 text-lg transition-all duration-300 transform hover:scale-105 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span id="btnText">Generate Presentation</span>
                            <span id="btnSpinner" style="display: none;">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Status Section -->
                <div id="statusSection" class="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl p-8 shadow-xl mb-8" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Generation Progress</h3>
                    
                    <!-- Overall Progress Bar -->
                    <div class="progress-bar-container">
                        <div id="overallProgressBar" class="progress-bar"></div>
                    </div>

                    <div class="space-y-4">
                        <div id="scriptStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">1</span>
                            <span class="status-text text-gray-600">Waiting to generate script...</span>
                        </div>
                        <div id="imagesStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">2</span>
                            <span class="status-text text-gray-600">Waiting to generate images...</span>
                        </div>
                        <div id="audioStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">3</span>
                            <span class="status-text text-gray-600">Waiting to generate audio...</span>
                        </div>
                        <div id="pdfStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">4</span>
                            <span class="status-text text-gray-600">Waiting to create PDF...</span>
                        </div>
                        <div id="videoChunksStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">5</span>
                            <span class="status-text text-gray-600">Waiting to generate video chunks...</span>
                        </div>
                        <div id="combineVideoStatus" class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <span class="status-icon status-pending w-8 h-8 rounded-full text-white font-bold flex items-center justify-center mr-4">6</span>
                            <span class="status-text text-gray-600">Waiting to combine video...</span>
                        </div>
                    </div>
                </div>

                <!-- Script Preview Section -->
                <div id="scriptPreview" class="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl p-8 shadow-xl mb-8" style="display: none;">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Generated Script Preview</h3>
                    <div id="scriptContent" class="space-y-4 max-h-96 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                        <!-- Script content will be populated here -->
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="bg-red-50 border border-red-200 rounded-2xl p-8 shadow-xl mb-8 text-center" style="display: none;">
                    <h3 class="text-2xl font-bold text-red-800 mb-4">⚠️ Error Occurred</h3>
                    <p id="errorMessage" class="text-red-600 mb-6"></p>
                    <button onclick="resetUI()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg">
                        Try Again
                    </button>
                </div>

                <!-- Download Section -->
                <div id="downloadSection" class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-2xl p-8 shadow-xl text-center" style="display: none;">
                    <h3 id="downloadSectionTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
                    <p id="downloadSectionMessage" class="text-gray-600 mb-6"></p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <a id="pdfViewer" href="#" download class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center" style="display: none;">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download PDF
                        </a>
                        <!-- Video download link can be added here if needed -->
                    </div>
                    <button onclick="showHistory()" class="mt-6 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg">Show Report</button>
                    <div id="reportContainer" style="margin-top: 20px; display: none; text-align: left;">
                      <h3 class="text-xl font-semibold text-gray-700 mb-3">Generated History</h3>
                      <table class="w-full border-collapse border border-gray-300">
                        <thead>
                          <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2">Topic</th>
                            <th class="border border-gray-300 px-4 py-2">Script</th>
                            <th class="border border-gray-300 px-4 py-2">PDF</th>
                            <th class="border border-gray-300 px-4 py-2">Video</th>
                          </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                      </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'https://sutradhaar.zsapiens.com';
        let currentScriptId = null;
        let currentPdfUrl = null; // To store the blob URL for the PDF
        let historyData = []; // Initialize as an empty array

        // Greeting rotation
        const greetings = [
            "Transform Text to Video", "पाठ को वीडियो में बदलें", "Trasforma il testo in video", 
            "转文本为视频", "حوّل النص إلى فيديو", "Transformez le texte en vidéo",
            "ಪಠ್ಯವನ್ನು ವೀಡಿಯೋಗೆ ಪरಿವರ್ತನೆ ಮಾಡಿ", "Chuyển đổi văn bản thành video", "पाठलाई भिडियामा रूपान्तरण गर्नुहोस्",
            "ലേഖനം വിഡിയോയുടെ രൂപത്തിലേക്ക് പരിവർത്തനം ചെയ്യുക", "मजकूराचें व्हिडियोंत रुपांतर करप", "पाठ के वीडियो में रूपांतरित करू",
            "Преобразовать текст в видео"
        ];
        let currentGreeting = 0;
        function rotateGreeting() {
            const greetingElement = document.getElementById('greetingText');
            if (greetingElement) {
                currentGreeting = (currentGreeting + 1) % greetings.length;
                greetingElement.textContent = greetings[currentGreeting];
            }
        }
        setInterval(rotateGreeting, 2500);

        function showMainPage() {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('mainPage').classList.remove('opacity-0', 'translate-y-10');
                document.getElementById('mainPage').classList.add('opacity-100', 'translate-y-0');
            }, 50);
        }

        function showSplashScreen() {
            document.getElementById('mainPage').classList.add('opacity-0', 'translate-y-10');
            document.getElementById('mainPage').classList.remove('opacity-100', 'translate-y-0');
            setTimeout(() => {
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('splashScreen').style.display = 'flex';
            }, 700);
        }

        function setSuggestion(suggestion) {
            document.getElementById('topic').value = suggestion;
        }

        async function generatePresentation() {
            console.log('Generate presentation clicked');
            const topic = document.getElementById('topic').value.trim();
            if (!topic) {
                showError('Please enter a topic for your presentation.');
                return;
            }

            resetUI();
            setButtonLoading(true);
            document.getElementById('statusSection').style.display = 'block';
            updateProgressBar(0); // Initialize progress bar

            try {
                // Step 1: Generate Script
                updateStatus('scriptStatus', 'loading', 'Generating script content...');
                const scriptRes = await fetch(`${API_BASE}/generate-script`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                if (!scriptRes.ok) throw new Error(`Script generation failed: ${ (await scriptRes.json().catch(()=>({}))).detail || scriptRes.statusText}`);
                
                const scriptData = await scriptRes.json();
                currentScriptId = scriptData.script_id;
                updateStatus('scriptStatus', 'success', 'Script generated successfully!');
                updateProgressBar(20); // Progress after script
                
                let parsedScriptForPreview = scriptData.parsed_script;
                if (typeof parsedScriptForPreview === 'string') {
                    try {
                        console.log("parsed_script is a string, attempting to parse JSON.");
                        parsedScriptForPreview = JSON.parse(parsedScriptForPreview);
                    } catch (e) {
                        console.error("Failed to parse script_data.parsed_script string:", e, "Raw string:", scriptData.parsed_script);
                        const scriptContentDiv = document.getElementById('scriptContent');
                        const scriptPreviewSection = document.getElementById('scriptPreview');
                        if (scriptContentDiv) {
                             scriptContentDiv.innerHTML = '<p class="text-red-600">Error: Script content is malformed and cannot be displayed.</p>';
                        }
                        if(scriptPreviewSection) scriptPreviewSection.style.display = 'block';
                        throw new Error("Malformed script data received. Cannot display preview."); 
                    }
                }
                await showScriptPreview(parsedScriptForPreview, scriptData.topic);


                // Step 2: Generate Images
                updateStatus('imagesStatus', 'loading', 'Generating images for slides...');
                const imagesRes = await fetch(`${API_BASE}/generate-images`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_id: currentScriptId, use_unsplash_fallback: true })
                });
                if (!imagesRes.ok) throw new Error(`Image generation failed: ${ (await imagesRes.json().catch(()=>({}))).detail || imagesRes.statusText}`);
                const imagesData = await imagesRes.json();
                updateStatus('imagesStatus', 'success', `Images generated! (${imagesData.stats.vertex_ai_success || 0} AI + ${imagesData.stats.unsplash_fallback || 0} stock)`);
                updateProgressBar(40); // Progress after images

                // Step 3: Generate Audio
                updateStatus('audioStatus', 'loading', 'Generating audio narrations...');
                const audioRes = await fetch(`${API_BASE}/generate-audio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_id: currentScriptId, speaker: document.querySelector('input[name="speaker"]:checked').value })
                });
                if (!audioRes.ok) throw new Error(`Audio generation failed: ${ (await audioRes.json().catch(()=>({}))).detail || audioRes.statusText}`);
                const audioData = await audioRes.json();
                updateStatus('audioStatus', 'success', `Audio generated! (${audioData.stats.successful || 0} files)`);
                updateProgressBar(60); // Progress after audio

                // Step 4: Generate PDF and show immediate download
                updateStatus('pdfStatus', 'loading', 'Creating PDF presentation...');
                const pdfRes = await fetch(`${API_BASE}/presentation/${currentScriptId}/pdf`);
                if (!pdfRes.ok) throw new Error(`PDF generation failed: ${ (await pdfRes.json().catch(()=>({}))).detail || pdfRes.statusText}`);
                
                const pdfBlob = await pdfRes.blob();
                const pdfUrl = URL.createObjectURL(pdfBlob);
                currentPdfUrl = pdfUrl; // Store for history and potential re-use
                updateStatus('pdfStatus', 'success', 'PDF presentation ready!');
                updateProgressBar(70); // Progress after PDF
                
                showPdfDownload(currentPdfUrl, `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_presentation.pdf`);

                // Continue with video generation in background
                generateVideoInBackground(currentScriptId, topic);

            } catch (error) {
                console.error('Generation error:', error);
                showError(error.message);
                setButtonLoading(false); 
                updateProgressBar(0, true); // Reset progress bar with error state
                ['pdfStatus', 'videoChunksStatus', 'combineVideoStatus'].forEach(statusId => {
                    const statusElement = document.getElementById(statusId);
                    if (statusElement && !statusElement.querySelector('.status-icon.status-success') && !statusElement.querySelector('.status-icon.status-error')) {
                         updateStatus(statusId, 'error', 'Skipped due to previous error');
                    }
                });
            }
        }

        async function generateVideoInBackground(scriptId, topic) {
            try {
                // Step 5: Generate Video Chunks
                updateStatus('videoChunksStatus', 'loading', 'Generating video chunks...');
                const videoChunksRes = await fetch(`${API_BASE}/generate-video-chunks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_id: scriptId })
                });
                const videoChunksData = await videoChunksRes.json();
                if (!videoChunksRes.ok || videoChunksData.chunks_successfully_generated === 0) {
                    throw new Error(`Video chunk generation failed: ${videoChunksData.detail || 'No chunks created'}`);
                }
                updateStatus('videoChunksStatus', 'success', `Chunks created: ${videoChunksData.chunks_successfully_generated}`);
                updateProgressBar(90); // Progress after video chunks

                // Step 6: Combine Chunks
                updateStatus('combineVideoStatus', 'loading', 'Combining video...');
                const combineRes = await fetch(`${API_BASE}/combine-video-chunks-fast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_id: scriptId, transition_type: "fade", transition_duration: 1.0 })
                });
                if (!combineRes.ok) throw new Error(`Combining video failed: ${ (await combineRes.json().catch(()=>({}))).detail || combineRes.statusText}`);
                
                const combineData = await combineRes.json();
                const videoFileName = combineData.final_video_path.split('/').pop();
                const videoUrl = `${API_BASE}/generated_final_videos/${scriptId}/${videoFileName}`;

                updateStatus('combineVideoStatus', 'success', 'Final video ready!');
                showVideoPlayer(videoUrl);
                updateProgressBar(100); // Progress after combining video

                const downloadTitle = document.getElementById('downloadSectionTitle');
                const downloadMessage = document.getElementById('downloadSectionMessage');
                if (downloadTitle) downloadTitle.textContent = '🎉 Presentation Ready!';
                if (downloadMessage) downloadMessage.textContent = 'Your presentation assets have been generated successfully.';

                historyData.push({
                    topic: topic,
                    script: `${API_BASE}/script/${scriptId}`, 
                    pdf: currentPdfUrl, 
                    video: videoUrl
                });

            } catch (error) {
                console.error('Video generation error:', error);
                updateStatus('videoChunksStatus', 'error', 'Video generation failed');
                updateStatus('combineVideoStatus', 'error', 'Video generation failed');
                updateProgressBar(document.getElementById('overallProgressBar').style.width.replace('%','') || 70, true); // Show error on progress bar at current stage
                const downloadMessage = document.getElementById('downloadSectionMessage');
                if (downloadMessage && document.getElementById('downloadSection').style.display === 'block') {
                     downloadMessage.textContent += ' However, video generation encountered an error.';
                } else if (!document.getElementById('downloadSection').style.display === 'block') {
                    showError(`Video generation failed: ${error.message}`);
                }
            } finally {
                setButtonLoading(false); 
            }
        }
        
        function updateProgressBar(percentage, isError = false) {
            const progressBar = document.getElementById('overallProgressBar');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                if (isError) {
                    progressBar.style.backgroundColor = '#ef4444'; // Tailwind red-500
                } else if (percentage === 100) {
                    progressBar.style.backgroundColor = '#10b981'; // Tailwind green-500
                }
                else {
                    progressBar.style.backgroundColor = '#3b82f6'; // Tailwind blue-500 (default)
                }
            }
        }

        function typewriterEffect(element, text, speed = 30) { // Default speed 30ms per word
            return new Promise(resolve => {
                let i = 0;
                const words = text.trim().split(/\s+/).filter(word => word.length > 0); // Split by words, filter empty

                element.innerHTML = ''; // Clear content for typing visual effect

                function type() {
                    if (i < words.length) {
                        element.innerHTML += (i > 0 ? ' ' : '') + words[i];
                        i++;
                        setTimeout(type, speed);
                        const scriptContentDiv = document.getElementById('scriptContent');
                        // Efficient scroll: only scroll if the element being typed into is the last child or its parent is last
                        if (element.isSameNode(scriptContentDiv.lastChild) || element.parentElement.isSameNode(scriptContentDiv.lastChild)) {
                           scriptContentDiv.scrollTop = scriptContentDiv.scrollHeight;
                        } else if (element.parentElement && element.parentElement.isSameNode(scriptContentDiv.lastChild.lastChild)) {
                            // For notes inside the last slide div
                            scriptContentDiv.scrollTop = scriptContentDiv.scrollHeight;
                        }

                    } else {
                        resolve(); 
                    }
                }
                
                if (words.length === 0) { // If text is empty or only whitespace
                    element.innerHTML = ''; 
                    resolve();
                    return;
                }
                type();
            });
        }

        async function showScriptPreview(script, topic) {
            const scriptPreviewSection = document.getElementById('scriptPreview');
            const scriptContentDiv = document.getElementById('scriptContent');
            if (!scriptPreviewSection || !scriptContentDiv) {
                console.error("Script preview elements not found.");
                return;
            }

            scriptContentDiv.innerHTML = ''; 

            // The script is expected to be an array of segments,
            // where each segment has a "slides" array.
            if (script && Array.isArray(script)) {
                let totalSlidesProcessed = 0;
                for (const segment of script) {
                    if (segment && typeof segment === 'object' && Array.isArray(segment.slides)) {
                        // Optionally display segment title if you want
                        if (segment.segment_title) {
                            const segmentTitleEl = document.createElement('h3');
                            segmentTitleEl.className = 'text-lg font-semibold text-purple-700 mt-4 mb-2 animate-fade-in';
                            scriptContentDiv.appendChild(segmentTitleEl);
                            await typewriterEffect(segmentTitleEl, `Segment: ${segment.segment_title.replace(/\*\*/g, '')}`, 50);
                        }
                        if (segment.summary) {
                            const segmentSummaryEl = document.createElement('p');
                            segmentSummaryEl.className = 'text-sm text-gray-600 mb-3 italic animate-fade-in';
                            scriptContentDiv.appendChild(segmentSummaryEl);
                            await typewriterEffect(segmentSummaryEl, `Summary: ${segment.summary}`, 30);
                        }

                        const slidesArray = segment.slides;
                        if (slidesArray.length > 0) {
                            for (const [index, slide] of slidesArray.entries()) {
                                totalSlidesProcessed++;
                                const slideDiv = document.createElement('div');
                                slideDiv.className = 'segment animate-fade-in'; 
                                scriptContentDiv.appendChild(slideDiv);
                                scriptContentDiv.scrollTop = scriptContentDiv.scrollHeight;

                                const titleText = `Slide ${totalSlidesProcessed}: ${slide.title || 'Untitled'}`;
                                const titleEl = document.createElement('h4');
                                titleEl.className = 'font-semibold text-blue-600';
                                slideDiv.appendChild(titleEl);
                                await typewriterEffect(titleEl, titleText, 50); 

                                // Use 'narration' field instead of 'content'
                                const narrationText = slide.narration || 'No narration'; 
                                const contentEl = document.createElement('p');
                                contentEl.className = 'text-sm text-gray-700';
                                slideDiv.appendChild(contentEl);
                                await typewriterEffect(contentEl, narrationText, 25); 

                                // Speaker notes are not in the provided example, but keeping the logic
                                if (slide.speaker_notes) {
                                    const notesText = `Notes: ${slide.speaker_notes}`;
                                    const notesContainerEl = document.createElement('p');
                                    notesContainerEl.className = 'text-xs text-gray-500 mt-1';
                                    slideDiv.appendChild(notesContainerEl);
                                    
                                    const emEl = document.createElement('em');
                                    notesContainerEl.appendChild(emEl);
                                    await typewriterEffect(emEl, notesText, 25);
                                }
                                scriptContentDiv.scrollTop = scriptContentDiv.scrollHeight;
                            }
                        }
                    } else {
                        console.warn("Segment object is malformed or missing 'slides' array:", segment);
                    }
                }
                if (totalSlidesProcessed === 0) {
                     scriptContentDiv.innerHTML = '<p class="text-gray-600">No slides found in the provided script segments.</p>';
                     console.warn("Script data parsed, but no valid slides found in segments:", script);
                }
            } else {
                scriptContentDiv.innerHTML = '<p class="text-gray-600">Could not display script content. Expected an array of segments, where each segment contains a "slides" array.</p>';
                console.warn("Script data for preview is not in the expected format (array of segments):", script);
            }
            scriptPreviewSection.style.display = 'block';
            scriptContentDiv.scrollTop = scriptContentDiv.scrollHeight; 
        }


        function showPdfDownload(pdfUrl, pdfName) {
            const downloadSection = document.getElementById('downloadSection');
            const pdfDownloadLink = document.getElementById('pdfViewer');
            const downloadTitle = document.getElementById('downloadSectionTitle');
            const downloadMessage = document.getElementById('downloadSectionMessage');
            
            if (pdfDownloadLink) {
                pdfDownloadLink.href = pdfUrl;
                pdfDownloadLink.download = pdfName;
                pdfDownloadLink.style.display = 'inline-flex';
            }
            
            if (downloadTitle) downloadTitle.textContent = '📄 PDF Ready for Download';
            if (downloadMessage) downloadMessage.textContent = 'Your PDF presentation is ready. Video generation is continuing in the background.';
            if (downloadSection) downloadSection.style.display = 'block';
        }

        function showVideoPlayer(videoUrl) {
            const videoPlayerElement = document.getElementById('videoPlayer');
            const videoSourceElement = document.getElementById('videoSource');

            if (videoPlayerElement && videoSourceElement && videoUrl) {
                videoSourceElement.setAttribute('src', videoUrl);
                videoPlayerElement.load();
                videoPlayerElement.style.display = 'block';
            }
        }

        function updateStatus(elementId, status, message) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const iconSpan = el.querySelector('.status-icon');
            const textSpan = el.querySelector('.status-text');

            if (iconSpan) {
                // Remove previous status classes for background
                iconSpan.classList.remove('status-pending', 'status-loading', 'status-success', 'status-error');
                // Add current status class for background
                iconSpan.classList.add(`status-${status}`);
                
                if (status === 'loading') {
                    iconSpan.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                } else if (status === 'success') {
                    iconSpan.textContent = '✓';
                } else if (status === 'error') {
                    iconSpan.textContent = '✕';
                } else { // pending or other
                    iconSpan.textContent = iconSpan.dataset.step || '?'; 
                }
            }
            if (textSpan) {
                textSpan.textContent = message;
                // Remove previous status classes for text color
                textSpan.classList.remove('status-pending', 'status-loading', 'status-success', 'status-error');
                // Add current status class for text color
                textSpan.classList.add(`status-${status}`);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            ['scriptStatus', 'imagesStatus', 'audioStatus', 'pdfStatus', 'videoChunksStatus', 'combineVideoStatus'].forEach((id, i) => {
                const el = document.getElementById(id);
                if (el) {
                    const icon = el.querySelector('.status-icon');
                    if(icon) icon.dataset.step = (i + 1).toString();
                }
            });
        });


        function showError(msg) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) errorMessage.textContent = msg;
            if (errorSection) errorSection.style.display = 'block';
            // Optionally hide status section if a major error occurs early
            // document.getElementById('statusSection').style.display = 'none'; 
        }

        function setButtonLoading(isLoading) {
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            if (btn) btn.disabled = isLoading;
            if (btnText) btnText.style.display = isLoading ? 'none' : 'inline';
            if (btnSpinner) btnSpinner.style.display = isLoading ? 'inline' : 'none';
        }

        function resetUI() {
            currentScriptId = null;
            currentPdfUrl = null; 
            
            updateProgressBar(0); // Reset progress bar

            const defaultMessages = {
                'scriptStatus': 'Waiting to generate script...',
                'imagesStatus': 'Waiting to generate images...',
                'audioStatus': 'Waiting to generate audio...',
                'pdfStatus': 'Waiting to create PDF...',
                'videoChunksStatus': 'Waiting to generate video chunks...',
                'combineVideoStatus': 'Waiting to combine video...'
            };

            ['scriptStatus', 'imagesStatus', 'audioStatus', 'pdfStatus', 'videoChunksStatus', 'combineVideoStatus'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    const icon = el.querySelector('.status-icon');
                    const text = el.querySelector('.status-text');
                    const stepNumber = icon ? icon.dataset.step : '';
                    
                    if (icon) {
                        icon.classList.remove('status-loading', 'status-success', 'status-error');
                        icon.classList.add('status-pending');
                        icon.innerHTML = stepNumber; 
                    }
                    if (text) {
                        text.textContent = defaultMessages[id] || 'Waiting...';
                        text.classList.remove('status-loading', 'status-success', 'status-error');
                        text.classList.add('status-pending');
                    }
                }
            });
            
            ['statusSection', 'scriptPreview', 'downloadSection', 'errorSection'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            document.getElementById('scriptContent').innerHTML = '';


            const downloadTitle = document.getElementById('downloadSectionTitle');
            const downloadMessage = document.getElementById('downloadSectionMessage');
            if (downloadTitle) downloadTitle.textContent = '';
            if (downloadMessage) downloadMessage.textContent = '';

            const pdfDownloadLink = document.getElementById('pdfViewer');
            if (pdfDownloadLink) {
                pdfDownloadLink.style.display = 'none';
                pdfDownloadLink.href = '#';
            }
            
            const videoPlayerElement = document.getElementById('videoPlayer');
            if (videoPlayerElement) {
                videoPlayerElement.style.display = 'none';
                const videoSourceElement = document.getElementById('videoSource');
                if (videoSourceElement) videoSourceElement.setAttribute('src', '');
                videoPlayerElement.load();
            }
        }

        function showHistory() {
            const container = document.getElementById('reportContainer');
            const body = document.getElementById('historyTableBody');
            body.innerHTML = ''; 
            
            if (historyData.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No history yet.</td></tr>';
            } else {
                historyData.forEach(item => {
                    const scriptLinkText = (item.script && item.script.startsWith('http')) ? 'View Script' : (item.script || 'N/A');
                    const pdfLinkText = 'Download PDF';
                    const videoLinkText = 'View Video';

                    const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-4 py-2">${item.topic || 'N/A'}</td>
                        <td class="px-4 py-2"><a href="${item.script}" target="_blank" class="text-blue-600 hover:underline">${scriptLinkText}</a></td>
                        <td class="px-4 py-2">
                            ${(item.pdf && item.pdf.startsWith('blob:')) 
                                ? `<a href="${item.pdf}" download="${item.topic.replace(/[^a-zA-Z0-9]/g, '_')}_presentation.pdf" class="text-blue-600 hover:underline">${pdfLinkText}</a>` 
                                : `<span class="text-gray-400" title="PDF link expired or unavailable">${pdfLinkText} (Unavailable)</span>`}
                        </td>
                        <td class="px-4 py-2">
                             ${(item.video && item.video.startsWith('http')) 
                                ? `<a href="${item.video}" target="_blank" class="text-blue-600 hover:underline">${videoLinkText}</a>` 
                                : `<span class="text-gray-400" title="Video link expired or unavailable">${videoLinkText} (Unavailable)</span>`}
                        </td>
                    </tr>
                    `;
                    body.innerHTML += row;
                });
            }
            container.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const topicInput = document.getElementById('topic');
            if (topicInput) {
                topicInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        generatePresentation();
                    }
                });
            }
        });
    </script>
</body>
</html>